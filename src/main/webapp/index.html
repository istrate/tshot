<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Troubleshooting Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            padding: 2rem;
        }
        
        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #34495e;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .section-title:first-child {
            margin-top: 0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        input:disabled,
        select:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        
        textarea {
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 100px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: 500;
            cursor: pointer;
        }
        
        .checkbox-with-input {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .checkbox-with-input .checkbox-part {
            display: flex;
            align-items: center;
            padding-top: 2rem;
        }
        
        .checkbox-with-input .checkbox-part input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        
        .checkbox-with-input .input-part {
            flex: 1;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        
        .result.success {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        .result.error {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .result pre {
            margin-top: 0.5rem;
            padding: 1rem;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.875rem;
        }
        
        .connection-preview {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .helper-text {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="appTitle">MongoDB Troubleshooting Tool</h1>
        <p id="appDescription">Test connections, run queries, and analyze MongoDB performance</p>
        <p id="hostnameInfo" style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;"></p>
    </div>
    
    <div class="container">
        
        <!-- Connection Configuration -->
        <div class="card">
            <h2>Connection Configuration</h2>
            
            <!-- Basic Connection -->
            <div class="section-title">Basic Connection</div>
            
            <div class="form-group">
                <label>Hosts</label>
                <div id="hostsContainer">
                    <div class="host-entry" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: flex-end;">
                        <div style="flex: 1;">
                            <input type="text" class="host-input" placeholder="localhost" value="localhost">
                        </div>
                        <div style="width: 150px;">
                            <input type="number" class="port-input" placeholder="27017" value="27017">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="removeHost(this)" style="padding: 0.75rem; margin: 0;">âœ•</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addHost()" style="margin-top: 0.5rem;">+ Add Host</button>
                <div class="helper-text">Add multiple hosts for replica set connections</div>
            </div>
            
            <div class="form-group">
                <label for="database">Database Name</label>
                <input type="text" id="database" placeholder="admin" value="admin">
            </div>
            
            <!-- Authentication -->
            <div class="section-title">Authentication</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="password">
                </div>
                <div class="form-group">
                    <label for="authDatabase">Authentication Database</label>
                    <input type="text" id="authDatabase" placeholder="admin" value="admin">
                </div>
            </div>
            
            <!-- Replica Set -->
            <div class="form-group">
                <label for="replicaSet">Replica Set Name (optional)</label>
                <input type="text" id="replicaSet" placeholder="rs0">
                <div class="helper-text">Leave empty for standalone MongoDB instances</div>
            </div>
            
            <!-- Advanced Options -->
            <div class="section-title">Advanced Options</div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="sslEnabled" onclick="toggleSSLOptions()">
                <label for="sslEnabled">Enable SSL/TLS</label>
            </div>
            
            <div id="sslOptionsContainer" style="margin-left: 2rem; display: none;">
                <div class="checkbox-group">
                    <input type="checkbox" id="tlsAllowInvalidCertificates">
                    <label for="tlsAllowInvalidCertificates">Allow Invalid Certificates (tlsAllowInvalidCertificates)</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="tlsAllowInvalidHostnames">
                    <label for="tlsAllowInvalidHostnames">Allow Invalid Hostnames (tlsAllowInvalidHostnames)</label>
                </div>
                
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="caCertFile">Upload MongoDB CA Certificate (optional)</label>
                    <input type="file" id="caCertFile" accept=".pem,.crt,.cer" onchange="handleCertificateUpload(this)">
                    <div class="helper-text">Upload the CA certificate to establish trust with MongoDB server</div>
                    <div id="certUploadStatus" style="margin-top: 0.5rem;"></div>
                </div>
            </div>
            
            <div class="checkbox-with-input">
                <div class="checkbox-part">
                    <input type="checkbox" id="readPrefEnabled" onclick="toggleField('readPreference', this.checked)">
                    <label for="readPrefEnabled">Read Preference</label>
                </div>
                <div class="input-part">
                    <div class="form-group">
                        <label for="readPreference">Read Preference Mode</label>
                        <select id="readPreference" disabled>
                            <option value="primary">primary</option>
                            <option value="primaryPreferred">primaryPreferred</option>
                            <option value="secondary">secondary</option>
                            <option value="secondaryPreferred">secondaryPreferred</option>
                            <option value="nearest">nearest</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="directConnection">
                <label for="directConnection">Direct Connection</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="retryWrites" checked>
                <label for="retryWrites">Retry Writes</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="retryReads" checked>
                <label for="retryReads">Retry Reads</label>
            </div>
            
            <!-- Timeouts -->
            <div class="section-title">Timeouts</div>
            
            <div class="checkbox-with-input">
                <div class="checkbox-part">
                    <input type="checkbox" id="connectTimeoutEnabled" onclick="toggleField('connectTimeout', this.checked)">
                    <label for="connectTimeoutEnabled">Connection Timeout</label>
                </div>
                <div class="input-part">
                    <div class="form-group">
                        <label for="connectTimeout">Timeout (milliseconds)</label>
                        <input type="number" id="connectTimeout" placeholder="10000" disabled>
                    </div>
                </div>
            </div>
            
            <div class="checkbox-with-input">
                <div class="checkbox-part">
                    <input type="checkbox" id="socketTimeoutEnabled" onclick="toggleField('socketTimeout', this.checked)">
                    <label for="socketTimeoutEnabled">Socket Timeout</label>
                </div>
                <div class="input-part">
                    <div class="form-group">
                        <label for="socketTimeout">Timeout (milliseconds)</label>
                        <input type="number" id="socketTimeout" placeholder="0" disabled>
                    </div>
                </div>
            </div>
            
            <div class="checkbox-with-input">
                <div class="checkbox-part">
                    <input type="checkbox" id="serverSelectionTimeoutEnabled" onclick="toggleField('serverSelectionTimeout', this.checked)">
                    <label for="serverSelectionTimeoutEnabled">Server Selection Timeout</label>
                </div>
                <div class="input-part">
                    <div class="form-group">
                        <label for="serverSelectionTimeout">Timeout (milliseconds)</label>
                        <input type="number" id="serverSelectionTimeout" placeholder="30000" disabled>
                    </div>
                </div>
            </div>
            
            <!-- Connection Pool -->
            <div class="section-title">Connection Pool</div>
            
            <div class="checkbox-with-input">
                <div class="checkbox-part">
                    <input type="checkbox" id="maxPoolSizeEnabled" onclick="toggleField('maxPoolSize', this.checked)">
                    <label for="maxPoolSizeEnabled">Max Pool Size</label>
                </div>
                <div class="input-part">
                    <div class="form-group">
                        <label for="maxPoolSize">Maximum Connections</label>
                        <input type="number" id="maxPoolSize" placeholder="100" disabled>
                    </div>
                </div>
            </div>
            
            <div class="checkbox-with-input">
                <div class="checkbox-part">
                    <input type="checkbox" id="minPoolSizeEnabled" onclick="toggleField('minPoolSize', this.checked)">
                    <label for="minPoolSizeEnabled">Min Pool Size</label>
                </div>
                <div class="input-part">
                    <div class="form-group">
                        <label for="minPoolSize">Minimum Connections</label>
                        <input type="number" id="minPoolSize" placeholder="0" disabled>
                    </div>
                </div>
            </div>
            
            <!-- Write Concern -->
            <div class="section-title">Write Concern</div>
            
            <div class="checkbox-with-input">
                <div class="checkbox-part">
                    <input type="checkbox" id="wEnabled" onclick="toggleField('w', this.checked)">
                    <label for="wEnabled">Write Concern W</label>
                </div>
                <div class="input-part">
                    <div class="form-group">
                        <label for="w">W Value (number or 'majority')</label>
                        <input type="text" id="w" placeholder="1" disabled>
                    </div>
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="journal">
                <label for="journal">Write Concern Journal</label>
            </div>
            
            <div class="checkbox-with-input">
                <div class="checkbox-part">
                    <input type="checkbox" id="wTimeoutEnabled" onclick="toggleField('wTimeout', this.checked)">
                    <label for="wTimeoutEnabled">Write Timeout</label>
                </div>
                <div class="input-part">
                    <div class="form-group">
                        <label for="wTimeout">Timeout (milliseconds)</label>
                        <input type="number" id="wTimeout" placeholder="0" disabled>
                    </div>
                </div>
            </div>
            
            <!-- Connection String Preview -->
            <div class="section-title">Connection String Preview</div>
            <div class="connection-preview" id="connectionStringPreview">mongodb://localhost:27017/admin</div>
            
            <!-- Connection Management -->
            <div class="section-title">Connection Management</div>
            <div id="connectionStatus" style="padding: 1rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 1rem;">
                <strong>Status:</strong> <span id="connectionStatusText" style="color: #dc3545;">Not Connected</span>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="openConnection()">Open Connection</button>
                <button class="btn btn-secondary" onclick="closeConnection()" id="closeConnectionBtn" disabled>Close Connection</button>
                <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
                <button class="btn btn-secondary" onclick="updateConnectionString()">Update Preview</button>
            </div>
            
            <div id="connectionResult" class="hidden"></div>
        </div>
        
        <!-- Query Executor -->
        <div class="card">
            <h2>Execute Query</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="queryDatabase">Database Name</label>
                    <input type="text" id="queryDatabase" placeholder="test" value="test">
                </div>
                <div class="form-group">
                    <label for="collection">Collection Name</label>
                    <input type="text" id="collection" placeholder="users" value="users">
                </div>
            </div>
            
            <div class="form-group">
                <label for="query">Query (JSON format)</label>
                <textarea id="query" placeholder='{"status": "active"}'>{}</textarea>
            </div>
            
            <button class="btn btn-primary" onclick="executeQuery()">Execute Query</button>
            <button class="btn btn-secondary" onclick="clearQuery()">Clear</button>
            <button class="btn btn-secondary" onclick="downloadQueryResults()" id="downloadQueryBtn" style="display:none;">ðŸ“¥ Download Results (JSON)</button>
            
            <div id="queryResult" class="hidden"></div>
        </div>
        
        <!-- Mongosh Command Executor -->
        <div class="card">
            <h2>Mongosh Command Executor</h2>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                Execute MongoDB shell commands directly. Examples: <code>db.User.countDocuments()</code>, <code>db.User.find({userid: "wilson"})</code>
            </p>
            
            <div class="form-group">
                <label for="mongoshDatabase">Database Name</label>
                <input type="text" id="mongoshDatabase" placeholder="test" value="test">
            </div>
            
            <div class="form-group">
                <label for="mongoshCommand">Mongosh Command</label>
                <textarea id="mongoshCommand" placeholder='db.User.countDocuments()' style="font-family: monospace;">db.User.countDocuments()</textarea>
                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                    <strong>Supported commands:</strong>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li><strong>Collection Operations:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1rem;">
                                <li><code>db.collection.find(query)</code> - Find documents</li>
                                <li><code>db.collection.findOne(query)</code> - Find one document</li>
                                <li><code>db.collection.countDocuments(query)</code> - Count documents</li>
                                <li><code>db.collection.distinct(field, query)</code> - Get distinct values</li>
                                <li><code>db.collection.aggregate(pipeline)</code> - Run aggregation</li>
                                <li><code>db.collection.getIndexes()</code> - List all indexes</li>
                                <li><code>db.collection.stats()</code> - Get collection statistics</li>
                            </ul>
                        </li>
                        <li><strong>Database Operations:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1rem;">
                                <li><code>show collections</code> - List all collections</li>
                                <li><code>show dbs</code> - List all databases</li>
                            </ul>
                        </li>
                        <li><strong>Server Operations:</strong>
                            <ul style="margin: 0.25rem 0; padding-left: 1rem;">
                                <li><code>db.serverStatus()</code> - Get server status</li>
                                <li><code>db.serverStatus().mem</code> - Get nested properties (e.g., memory stats)</li>
                                <li><code>db.currentOp()</code> - Get current operations</li>
                                <li><code>db.currentOp({$all: true})</code> - Get all operations with filter</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="executeMongoshCommand()">Execute Command</button>
            <button class="btn btn-secondary" onclick="clearMongoshCommand()">Clear</button>
            <button class="btn btn-secondary" onclick="downloadMongoshResults()" id="downloadMongoshBtn" style="display:none;">ðŸ“¥ Download Results (JSON)</button>
            
            <div id="mongoshResult" class="hidden"></div>
        </div>
        
        <!-- Database Statistics -->
        <div class="card">
            <h2>Database Statistics</h2>
            
            <div class="form-group">
                <label for="statsDatabase">Database Name</label>
                <input type="text" id="statsDatabase" placeholder="test" value="test">
            </div>
            
            <button class="btn btn-primary" onclick="getStats()">Get Statistics</button>
            <button class="btn btn-secondary" onclick="downloadStats()" id="downloadStatsBtn" style="display:none;">ðŸ“¥ Download Stats (JSON)</button>
            
            <div id="statsResult" class="hidden"></div>
        </div>
        
    </div>
    
    <script>
        var uploadedCertificateId = null;
        var lastQueryResults = null;
        var lastStatsResults = null;
        var isConnected = false;
        
        // Load application configuration on page load
        function loadAppConfig() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/config', true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var config = JSON.parse(xhr.responseText);
                        
                        // Update page title
                        document.title = config.appName;
                        
                        // Update header
                        document.getElementById('appTitle').textContent = config.appName;
                        
                        // Update hostname info
                        if (config.hostname) {
                            document.getElementById('hostnameInfo').textContent = 'Running on: ' + config.hostname;
                        }
                        
                        console.log('App config loaded:', config);
                    } catch (e) {
                        console.error('Failed to parse config:', e);
                    }
                } else {
                    console.error('Failed to load config:', xhr.status);
                }
            };
            
            xhr.onerror = function() {
                console.error('Network error loading config');
            };
            
            xhr.send();
        }
        
        // Load config when page loads
        window.addEventListener('DOMContentLoaded', loadAppConfig);
        
        function updateConnectionStatus(connected, message) {
            isConnected = connected;
            var statusText = document.getElementById('connectionStatusText');
            var closeBtn = document.getElementById('closeConnectionBtn');
            
            if (connected) {
                statusText.textContent = 'Connected';
                statusText.style.color = '#28a745';
                closeBtn.disabled = false;
            } else {
                statusText.textContent = 'Not Connected';
                statusText.style.color = '#dc3545';
                closeBtn.disabled = true;
            }
            
            if (message) {
                statusText.textContent += ' - ' + message;
            }
        }
        
        function openConnection() {
            var connectionString = buildConnectionString();
            var resultDiv = document.getElementById('connectionResult');
            
            resultDiv.innerHTML = '<div class="result">Opening connection<span class="loading"></span></div>';
            resultDiv.classList.remove('hidden');
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/mongo', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        showResult('connectionResult', data, data.success);
                        if (data.success) {
                            updateConnectionStatus(true, 'Session active');
                        }
                    } catch (e) {
                        showResult('connectionResult', {success: false, message: 'Invalid response: ' + xhr.responseText}, false);
                    }
                } else {
                    showResult('connectionResult', {success: false, message: 'HTTP Error: ' + xhr.status}, false);
                }
            };
            
            xhr.onerror = function() {
                showResult('connectionResult', {success: false, message: 'Network error'}, false);
            };
            
            var params = 'action=openConnection&connectionString=' + encodeURIComponent(connectionString);
            if (uploadedCertificateId) {
                params += '&certificateId=' + encodeURIComponent(uploadedCertificateId);
            }
            
            xhr.send(params);
        }
        
        function closeConnection() {
            var resultDiv = document.getElementById('connectionResult');
            
            resultDiv.innerHTML = '<div class="result">Closing connection<span class="loading"></span></div>';
            resultDiv.classList.remove('hidden');
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/mongo', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        showResult('connectionResult', data, data.success);
                        if (data.success) {
                            updateConnectionStatus(false);
                        }
                    } catch (e) {
                        showResult('connectionResult', {success: false, message: 'Invalid response: ' + xhr.responseText}, false);
                    }
                } else {
                    showResult('connectionResult', {success: false, message: 'HTTP Error: ' + xhr.status}, false);
                }
            };
            
            xhr.onerror = function() {
                showResult('connectionResult', {success: false, message: 'Network error'}, false);
            };
            
            xhr.send('action=closeConnection');
        }
        
        function toggleSSLOptions() {
            try {
                var sslEnabled = document.getElementById('sslEnabled').checked;
                var sslContainer = document.getElementById('sslOptionsContainer');
                if (sslContainer) {
                    sslContainer.style.display = sslEnabled ? 'block' : 'none';
                }
                if (!sslEnabled) {
                    document.getElementById('tlsAllowInvalidCertificates').checked = false;
                    document.getElementById('tlsAllowInvalidHostnames').checked = false;
                    uploadedCertificateId = null;
                }
            } catch(e) {
                console.error('Error in toggleSSLOptions:', e);
            }
        }
        
        function handleCertificateUpload(input) {
            try {
                var statusDiv = document.getElementById('certUploadStatus');
                
                if (!input.files || input.files.length === 0) {
                    statusDiv.innerHTML = '';
                    uploadedCertificateId = null;
                    return;
                }
                
                var file = input.files[0];
                statusDiv.innerHTML = '<span style="color: #3498db;">Uploading certificate...</span>';
                
                var formData = new FormData();
                formData.append('certificate', file);
                
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/cert', true);
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                uploadedCertificateId = response.certificateId;
                                statusDiv.innerHTML = '<span style="color: #28a745;">âœ“ Certificate uploaded successfully (ID: ' +
                                    response.certificateId + ')</span>';
                            } else {
                                statusDiv.innerHTML = '<span style="color: #dc3545;">âœ— Upload failed: ' +
                                    response.message + '</span>';
                                uploadedCertificateId = null;
                            }
                        } catch (e) {
                            statusDiv.innerHTML = '<span style="color: #dc3545;">âœ— Invalid response</span>';
                            uploadedCertificateId = null;
                        }
                    } else {
                        statusDiv.innerHTML = '<span style="color: #dc3545;">âœ— Upload failed (HTTP ' + xhr.status + ')</span>';
                        uploadedCertificateId = null;
                    }
                };
                
                xhr.onerror = function() {
                    statusDiv.innerHTML = '<span style="color: #dc3545;">âœ— Network error</span>';
                    uploadedCertificateId = null;
                };
                
                xhr.send(formData);
            } catch(e) {
                console.error('Error uploading certificate:', e);
                document.getElementById('certUploadStatus').innerHTML =
                    '<span style="color: #dc3545;">âœ— Error: ' + e.message + '</span>';
            }
        }
        
        function toggleField(fieldId, enabled) {
            try {
                var field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = !enabled;
                }
            } catch(e) {
                console.error('Error in toggleField:', e);
            }
        }
        
        function addHost() {
            try {
                var container = document.getElementById('hostsContainer');
                var hostEntry = document.createElement('div');
                hostEntry.className = 'host-entry';
                hostEntry.style.display = 'flex';
                hostEntry.style.gap = '0.5rem';
                hostEntry.style.marginBottom = '0.5rem';
                hostEntry.style.alignItems = 'flex-end';
                
                hostEntry.innerHTML =
                    '<div style="flex: 1;">' +
                    '<input type="text" class="host-input" placeholder="localhost">' +
                    '</div>' +
                    '<div style="width: 150px;">' +
                    '<input type="number" class="port-input" placeholder="27017">' +
                    '</div>' +
                    '<button type="button" class="btn btn-secondary" onclick="removeHost(this)" style="padding: 0.75rem; margin: 0;">âœ•</button>';
                
                container.appendChild(hostEntry);
            } catch(e) {
                console.error('Error adding host:', e);
            }
        }
        
        function removeHost(button) {
            try {
                var container = document.getElementById('hostsContainer');
                if (container.children.length > 1) {
                    button.closest('.host-entry').remove();
                }
            } catch(e) {
                console.error('Error removing host:', e);
            }
        }
        
        function buildConnectionString() {
            try {
                var database = document.getElementById('database').value || 'admin';
                var username = document.getElementById('username').value;
                var password = document.getElementById('password').value;
                var authDatabase = document.getElementById('authDatabase').value;
                var replicaSet = document.getElementById('replicaSet').value;
                
                // Collect all hosts
                var hostInputs = document.querySelectorAll('.host-input');
                var portInputs = document.querySelectorAll('.port-input');
                var hosts = [];
                
                for (var i = 0; i < hostInputs.length; i++) {
                    var host = hostInputs[i].value.trim() || 'localhost';
                    var port = portInputs[i].value.trim() || '27017';
                    hosts.push(host + ':' + port);
                }
                
                if (hosts.length === 0) {
                    hosts.push('localhost:27017');
                }
                
                var connStr = 'mongodb://';
                
                if (username && password) {
                    connStr += encodeURIComponent(username) + ':' + encodeURIComponent(password) + '@';
                }
                
                connStr += hosts.join(',') + '/' + database;
                
                var params = [];
                
                if (authDatabase && username) {
                    params.push('authSource=' + encodeURIComponent(authDatabase));
                }
                
                if (replicaSet) {
                    params.push('replicaSet=' + encodeURIComponent(replicaSet));
                }
                
                if (document.getElementById('sslEnabled').checked) {
                    params.push('ssl=true');
                    params.push('tls=true');
                    if (document.getElementById('tlsAllowInvalidCertificates').checked) {
                        params.push('tlsAllowInvalidCertificates=true');
                    }
                    if (document.getElementById('tlsAllowInvalidHostnames').checked) {
                        params.push('tlsAllowInvalidHostnames=true');
                    }
                }
                
                if (document.getElementById('readPrefEnabled').checked) {
                    var readPref = document.getElementById('readPreference').value;
                    if (readPref) {
                        params.push('readPreference=' + readPref);
                    }
                }
                
                if (document.getElementById('directConnection').checked) {
                    params.push('directConnection=true');
                }
                
                if (document.getElementById('retryWrites').checked) {
                    params.push('retryWrites=true');
                }
                
                if (document.getElementById('retryReads').checked) {
                    params.push('retryReads=true');
                }
                
                if (document.getElementById('connectTimeoutEnabled').checked) {
                    var connectTimeout = document.getElementById('connectTimeout').value;
                    if (connectTimeout) {
                        params.push('connectTimeoutMS=' + connectTimeout);
                    }
                }
                
                if (document.getElementById('socketTimeoutEnabled').checked) {
                    var socketTimeout = document.getElementById('socketTimeout').value;
                    if (socketTimeout) {
                        params.push('socketTimeoutMS=' + socketTimeout);
                    }
                }
                
                if (document.getElementById('serverSelectionTimeoutEnabled').checked) {
                    var serverSelectionTimeout = document.getElementById('serverSelectionTimeout').value;
                    if (serverSelectionTimeout) {
                        params.push('serverSelectionTimeoutMS=' + serverSelectionTimeout);
                    }
                }
                
                if (document.getElementById('maxPoolSizeEnabled').checked) {
                    var maxPoolSize = document.getElementById('maxPoolSize').value;
                    if (maxPoolSize) {
                        params.push('maxPoolSize=' + maxPoolSize);
                    }
                }
                
                if (document.getElementById('minPoolSizeEnabled').checked) {
                    var minPoolSize = document.getElementById('minPoolSize').value;
                    if (minPoolSize) {
                        params.push('minPoolSize=' + minPoolSize);
                    }
                }
                
                if (document.getElementById('wEnabled').checked) {
                    var w = document.getElementById('w').value;
                    if (w) {
                        params.push('w=' + encodeURIComponent(w));
                    }
                }
                
                if (document.getElementById('journal').checked) {
                    params.push('journal=true');
                }
                
                if (document.getElementById('wTimeoutEnabled').checked) {
                    var wTimeout = document.getElementById('wTimeout').value;
                    if (wTimeout) {
                        params.push('wtimeoutMS=' + wTimeout);
                    }
                }
                
                if (params.length > 0) {
                    connStr += '?' + params.join('&');
                }
                
                return connStr;
            } catch(e) {
                console.error('Error building connection string:', e);
                return 'mongodb://localhost:27017/admin';
            }
        }
        
        function updateConnectionString() {
            try {
                var connStr = buildConnectionString();
                document.getElementById('connectionStringPreview').textContent = connStr;
            } catch(e) {
                console.error('Error updating connection string:', e);
            }
        }
        
        function showResult(elementId, data, isSuccess) {
            var element = document.getElementById(elementId);
            var className = isSuccess ? 'result success' : 'result error';
            var title = isSuccess ? 'Success' : 'Error';
            
            element.innerHTML = '<div class="' + className + '">' +
                '<strong>' + title + '</strong>' +
                '<pre>' + JSON.stringify(data, null, 2) + '</pre>' +
                '</div>';
            element.classList.remove('hidden');
        }
        
        function testConnection() {
            var connectionString = buildConnectionString();
            var resultDiv = document.getElementById('connectionResult');
            
            resultDiv.innerHTML = '<div class="result">Testing connection<span class="loading"></span></div>';
            resultDiv.classList.remove('hidden');
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/mongo', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        showResult('connectionResult', data, data.success);
                    } catch (e) {
                        showResult('connectionResult', {success: false, message: 'Invalid response: ' + xhr.responseText}, false);
                    }
                } else {
                    showResult('connectionResult', {success: false, message: 'HTTP Error: ' + xhr.status}, false);
                }
            };
            
            xhr.onerror = function() {
                showResult('connectionResult', {success: false, message: 'Network error'}, false);
            };
            
            var params = 'action=testConnection&connectionString=' + encodeURIComponent(connectionString);
            if (uploadedCertificateId) {
                params += '&certificateId=' + encodeURIComponent(uploadedCertificateId);
            }
            
            xhr.send(params);
        }
        
        function executeQuery() {
            var connectionString = buildConnectionString();
            var database = document.getElementById('queryDatabase').value;
            var collection = document.getElementById('collection').value;
            var query = document.getElementById('query').value;
            var resultDiv = document.getElementById('queryResult');
            
            resultDiv.innerHTML = '<div class="result">Executing query<span class="loading"></span></div>';
            resultDiv.classList.remove('hidden');
            document.getElementById('downloadQueryBtn').style.display = 'none';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/mongo', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        lastQueryResults = data;
                        showResult('queryResult', data, data.success);
                        if (data.success && data.results && data.results.length > 0) {
                            document.getElementById('downloadQueryBtn').style.display = 'inline-block';
                        }
                    } catch (e) {
                        showResult('queryResult', {success: false, message: 'Invalid response: ' + xhr.responseText}, false);
                    }
                } else {
                    showResult('queryResult', {success: false, message: 'HTTP Error: ' + xhr.status}, false);
                }
            };
            
            xhr.onerror = function() {
                showResult('queryResult', {success: false, message: 'Network error'}, false);
            };
            
            var params = 'action=executeQuery' +
                '&connectionString=' + encodeURIComponent(connectionString) +
                '&database=' + encodeURIComponent(database) +
                '&collection=' + encodeURIComponent(collection) +
                '&query=' + encodeURIComponent(query);
            
            if (uploadedCertificateId) {
                params += '&certificateId=' + encodeURIComponent(uploadedCertificateId);
            }
            
            xhr.send(params);
        }
        
        function getStats() {
            var connectionString = buildConnectionString();
            var database = document.getElementById('statsDatabase').value;
            var resultDiv = document.getElementById('statsResult');
            
            resultDiv.innerHTML = '<div class="result">Getting statistics<span class="loading"></span></div>';
            resultDiv.classList.remove('hidden');
            document.getElementById('downloadStatsBtn').style.display = 'none';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/mongo', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        lastStatsResults = data;
                        showResult('statsResult', data, data.success);
                        if (data.success) {
                            document.getElementById('downloadStatsBtn').style.display = 'inline-block';
                        }
                    } catch (e) {
                        showResult('statsResult', {success: false, message: 'Invalid response: ' + xhr.responseText}, false);
                    }
                } else {
                    showResult('statsResult', {success: false, message: 'HTTP Error: ' + xhr.status}, false);
                }
            };
            
            xhr.onerror = function() {
                showResult('statsResult', {success: false, message: 'Network error'}, false);
            };
            
            var params = 'action=getStats' +
                '&connectionString=' + encodeURIComponent(connectionString) +
                '&database=' + encodeURIComponent(database);
            
            if (uploadedCertificateId) {
                params += '&certificateId=' + encodeURIComponent(uploadedCertificateId);
            }
            
            xhr.send(params);
        }
        
        function downloadQueryResults() {
            if (!lastQueryResults || !lastQueryResults.results) {
                alert('No query results to download');
                return;
            }
            
            var database = document.getElementById('queryDatabase').value;
            var collection = document.getElementById('collection').value;
            var timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            var filename = 'query-results_' + database + '_' + collection + '_' + timestamp + '.json';
            
            var dataStr = JSON.stringify(lastQueryResults, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            var link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }
        
        function downloadStats() {
            if (!lastStatsResults) {
                alert('No statistics to download');
                return;
            }
            
            var database = document.getElementById('statsDatabase').value;
            var timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            var filename = 'db-stats_' + database + '_' + timestamp + '.json';
            
            var dataStr = JSON.stringify(lastStatsResults, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            var link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }
        
        function clearQuery() {
            document.getElementById('query').value = '{}';
            document.getElementById('queryResult').classList.add('hidden');
            document.getElementById('downloadQueryBtn').style.display = 'none';
            lastQueryResults = null;
        }
        
        var lastMongoshResults = null;
        
        function executeMongoshCommand() {
            var connectionString = buildConnectionString();
            var database = document.getElementById('mongoshDatabase').value;
            var command = document.getElementById('mongoshCommand').value;
            var resultDiv = document.getElementById('mongoshResult');
            
            resultDiv.innerHTML = '<div class="result">Executing mongosh command<span class="loading"></span></div>';
            resultDiv.classList.remove('hidden');
            document.getElementById('downloadMongoshBtn').style.display = 'none';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/mongo', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        lastMongoshResults = data;
                        showResult('mongoshResult', data, data.success);
                        if (data.success && data.results) {
                            document.getElementById('downloadMongoshBtn').style.display = 'inline-block';
                        }
                    } catch (e) {
                        showResult('mongoshResult', {success: false, message: 'Invalid response: ' + xhr.responseText}, false);
                    }
                } else {
                    showResult('mongoshResult', {success: false, message: 'HTTP Error: ' + xhr.status}, false);
                }
            };
            
            xhr.onerror = function() {
                showResult('mongoshResult', {success: false, message: 'Network error'}, false);
            };
            
            var params = 'action=executeMongosh' +
                '&connectionString=' + encodeURIComponent(connectionString) +
                '&database=' + encodeURIComponent(database) +
                '&command=' + encodeURIComponent(command);
            
            if (uploadedCertificateId) {
                params += '&certificateId=' + encodeURIComponent(uploadedCertificateId);
            }
            
            xhr.send(params);
        }
        
        function clearMongoshCommand() {
            document.getElementById('mongoshCommand').value = 'db.User.countDocuments()';
            document.getElementById('mongoshResult').classList.add('hidden');
            document.getElementById('downloadMongoshBtn').style.display = 'none';
            lastMongoshResults = null;
        }
        
        function downloadMongoshResults() {
            if (!lastMongoshResults) {
                alert('No results to download');
                return;
            }
            
            var database = document.getElementById('mongoshDatabase').value;
            var timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            var filename = 'mongosh-results_' + database + '_' + timestamp + '.json';
            
            var dataStr = JSON.stringify(lastMongoshResults, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            var link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }
    </script>
</body>
</html>